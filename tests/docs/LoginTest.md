# LoginTest テスト概要

このドキュメントでは、ユーザーのログイン機能に関するテストケースについて、わかりやすく説明します。

---

## 1. テストの目的

- **ログインページ表示の確認**  
  ユーザーが管理者用ログインページ ("/admin/login") に正常にアクセスできることを確認します。

- **正しい資格情報によるログイン成功の検証**  
  正しいユーザー名とパスワードを入力した場合に、ユーザーが認証され、ダッシュボードへリダイレクトされるかをチェックします。

- **ログイン失敗の動作検証**  
  誤ったパスワードや非アクティブなユーザーがログインできないことを確認し、セキュリティが保たれることを検証します。

- **ログイン試行の追跡とブロック機能の確認**  
  ログイン試行がデータベースに記録されること、及び設定された試行回数を超えた場合にユーザーがブロックされることを確認します。

---

## 2. テストケースの詳細

### 2.1. ログインページの表示 (test_user_can_view_login_page)
- **目的**:  
  GETリクエストで "/admin/login" にアクセスし、HTTPステータスコード200が返されることを確認します。

- **検証内容**:  
  - ログインページが正しく表示されるか（ステータス200）。

---

### 2.2. 正しい資格情報でのログイン (test_user_can_login_with_correct_credentials)
- **目的**:  
  正しいユーザー名とパスワードを使用した場合、ユーザーが正常に認証されるか確認します。

- **検証内容**:  
  - Livewire のテストで、ユーザー名とパスワードを設定し、`authenticate` メソッドを呼び出す。
  - ログイン後、ユーザーが認証状態にあるか (\( Auth::check() \) が true) 確認。
  - 認証されたユーザーのIDが、作成したユーザーのIDと一致するか確認。

---

### 2.3. ログイン成功後のリダイレクト (test_login_redirects_to_dashboard)
- **目的**:  
  ログイン成功後に、ユーザーがダッシュボード ("/admin") にリダイレクトされるか検証します。

- **検証内容**:  
  - `authenticate` の呼び出し後、リダイレクト先が "/admin" であることを確認。
  - 認証状態が正しく保持されていることを確認。

---

### 2.4. 誤ったパスワードでのログイン失敗 (test_user_cannot_login_with_incorrect_password)
- **目的**:  
  ユーザーが誤ったパスワードでログインを試みた場合、認証されずログインが失敗することを確認します。

- **検証内容**:  
  - 誤ったパスワードを使った場合、\( Auth::check() \) が false となることを確認。

---

### 2.5. 非アクティブユーザーでのログイン失敗 (test_inactive_user_cannot_login)
- **目的**:  
  `is_active` フィールドが false のユーザーはログインできないことを検証します。

- **検証内容**:  
  - 非アクティブなユーザーでログイン試行を行った後、認証がされないことを確認。

---

### 2.6. ログイン試行の追跡 (test_login_attempts_are_tracked)
- **目的**:  
  誤ったパスワードでのログイン試行が、`login_attempts` テーブルに記録されることを確認します。

- **検証内容**:  
  - 指定された IP アドレス (例: "127.0.0.1") からの誤ったログイン試行後、データベースに該当する記録が存在することを検証。

---

### 2.7. ログイン試行の上限超過によるブロック (test_user_is_blocked_after_too_many_attempts)
- **目的**:  
  設定した上限回数 (\( config('auth.attempt_limit') \)) を超えた場合、ユーザーがブロックされ、ログインに失敗することを確認します。

- **検証内容**:  
  - 前もって IP アドレスに対して既に上限の試行回数が記録された状態で、正しい資格情報を使ってログインを試みる。
  - 結果として、ユーザーが認証されず、ブロックされることを確認。

---

## 3. テスト実行方法と実装上の注意点

- **テストフレームワーク**:  
  PHPUnit を使用してテストスイートを実行します。各テストは `RefreshDatabase` トレイトにより、実行前にデータベースがリセットされます。

- **Livewire のテスト**:  
  Livewire のテストヘルパーを使用して、コンポーネントの動作（値のセットやメソッドの呼び出し）をシミュレートしています。

- **外部サービスの無効化**:  
  セットアップ内で Turnstile の設定値を無効化しているため、キャプチャ認証による影響を受けず、テストが円滑に実行されます。

- **ログイン試行の管理**:  
  ログイン試行の追跡やブロック機能は、実際のサービスの設定 (例: \( config('auth.attempt_limit') \)) に依存しているため、テスト環境で正確にシミュレートされています。

---

このテスト計画により、ユーザー認証の正確性とセキュリティ対策が十分であることを確認し、ログインプロセスにおける不正アクセスや認証エラーを未然に防ぐための堅牢なシステムが構築されていることを保証します。
