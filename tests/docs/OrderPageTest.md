# OrderPageTest テスト概要

このドキュメントでは、`OrderPage` コンポーネントの各機能に対するテストケースの目的と内容について、わかりやすく説明します。

---

## 1. テストの目的

- **カートの初期化と合計金額の計算**  
  - セッションに保存されているカート情報を正しく読み込み、初期状態として正しい内容（商品の数、合計金額）が設定されることを検証します。

- **商品の追加および数量の管理**  
  - 空のカートに商品を追加する機能  
  - 既にカートに存在する商品の場合、数量がインクリメントされ合計金額が再計算されること  
  - 在庫数が不足している場合に、商品の追加が制限されること

- **数量更新と商品の削除**  
  - カート内の商品数量を変更し、合計金額が正しく更新されること  
  - 数量をゼロにした場合に、カートから商品が削除されること  
  - 明示的に商品を削除する処理が正しく動作すること

- **支払い金額とお釣りの計算**  
  - 支払金額に基づいてお釣り額を正確に計算できること  
  - 支払い金額の更新が正しく反映されること

- **注文の確定処理**  
  - 正常な注文の場合、カートが空にされ、在庫数が減少し、データベースに注文情報が登録されること  
  - カートが空の場合や、支払い金額が不足している場合に、注文が確定しないこと

- **商品のオプション選択機能**  
  - オプションが存在する商品の場合、オプション選択用のポップアップが表示されること  
  - オプションを選択して注文に反映させると、商品の金額がオプションの金額分加算されること  
  - オプション選択をキャンセルすると、関連する選択状態がリセットされること

---

## 2. テストケースの詳細

### 2.1. カート初期化と合計金額計算 (`mount initializes cart and total price`)
- **目的**:  
  セッションに保持しているカート情報をロードし、`mount()` メソッド実行後にカートと合計金額が正しく初期化されることを確認します。

- **検証内容**:
  - セッションにあらかじめカート情報（例: 商品が 2 個入っている状態）をセット。
  - 対応する製品をデータベースに登録。
  - `mount()` 呼び出し後、カート内の商品の件数が 1 件、合計金額が 200 になっていること。

---

### 2.2. 商品の追加 (`addToCart success`)
- **目的**:  
  空のカートに商品を追加する際に、カートの状態、数量、合計金額、そしてセッションへの保存が正しく行われることを確認します。

- **検証内容**:
  - テスト用の商品を作成し、`addToCart()` を実行  
  - カートに追加された商品の ID や数量が正しく設定され、合計金額が商品の価格と一致していること  
  - セッションのカート情報がコンポーネントのカート状態と同一であること

---

### 2.3. 既存商品の数量インクリメント (`addToCart increments quantity if item exists`)
- **目的**:  
  既にカートに存在する商品の再追加時に、数量が増加し、合計金額もそれに応じて更新されるかを検証します。

- **検証内容**:
  - 同一商品を 2 回追加した場合、カートに存在する商品の数量が 2 になり、合計金額もその倍になっていること。

---

### 2.4. 在庫不足時の追加制限 (`addToCart does not add when stock insufficient`)
- **目的**:  
  商品の在庫数が不足している場合、追加処理が行われず、カート内の数量が在庫上限を超えないことを確認します。

- **検証内容**:
  - 在庫が 1 の商品を 2 回追加しようとした場合、カート内の数量は 1 のままになること。

---

### 2.5. 数量更新処理 (`updateQuantity updates quantity correctly`)
- **目的**:  
  カート内の商品の数量を更新した際に、数量と合計金額が正しく調整されること。

- **検証内容**:
  - 商品をカートに追加後、数量を 3 に更新し、合計金額が商品単価の 3 倍になっていること。

---

### 2.6. ゼロ数量での削除 (`updateQuantity removes item when quantity set to zero`)
- **目的**:  
  数量を 0 に更新することで、カートから対象商品のエントリーが削除されることを検証します。

- **検証内容**:
  - 数量変更後、カートが空になり、合計金額が 0 になること。

---

### 2.7. 商品の削除 (`removeFromCart removes item correctly`)
- **目的**:  
  カートから特定の商品を削除する機能が正しく動作するかを確認します。

- **検証内容**:
  - 商品をカートに追加後、`removeFromCart()` を実行し、カート内の商品がなくなること。

---

### 2.8. お釣り計算 (`calculateChange calculates correctly`)
- **目的**:  
  支払い額と合計金額の差額として正しいお釣り額が計算されるかを検証します。

- **検証内容**:
  - 合計金額 500、支払い金額 800 の状態で、お釣りが 300 と計算されること。

---

### 2.9. 支払い金額の更新 (`updatedPaymentAmount updates correctly`)
- **目的**:  
  支払い金額の更新が正しく反映されることを確認します。

- **検証内容**:
  - 入力値 1000 の場合、支払い金額が更新され、空文字の場合は 0 にリセットされること。

---

### 2.10. 注文確定処理の成功 (`confirmOrder successful order`)
- **目的**:  
  正常な注文処理において、カートがクリアされ、在庫数が減少、データベースに注文情報が登録されることを確認します。

- **検証内容**:
  - 商品をカートに追加し、支払い金額を設定した上で `confirmOrder()` を実行  
  - 注文確定後、カートが空になり、支払いポップアップが非表示になり、セッションのカート情報もリセットされる  
  - 商品の在庫が 1 減少し、`orders` テーブルに該当するレコードが登録されていること

---

### 2.11. 空のカートでの注文失敗 (`confirmOrder fails with empty cart`)
- **目的**:  
  カートが空の場合には注文処理が実行されず、状態が変化しないことを確認します。

- **検証内容**:
  - カートが空の状態で `confirmOrder()` を呼び出し、カートの状態が変わらないこと。

---

### 2.12. 支払い不足による注文失敗 (`confirmOrder fails with insufficient payment`)
- **目的**:  
  支払い金額が不足している場合、注文が確定せず在庫数に変更がないこと、かつデータベースに注文情報が登録されないことを確認します。

- **検証内容**:  
  - カートに商品を追加し、支払い金額が合計金額を下回る状態で `confirmOrder()` を実行  
  - 注文失敗後、商品の在庫が変更されず、`orders` テーブルにデータが存在しないこと

---

### 2.13. オプション選択ポップアップ表示 (`handleProductClick shows options popup when options exist`)
- **目的**:  
  商品にオプションが存在する場合、クリック時にオプション選択のポップアップが表示され、選択対象の情報がセットされることを確認します。

- **検証内容**:
  - オプション付きの製品を作成し、クリック処理を実行した際に、`showOptionsPopup` が true になり、`selectedProductId` と `selectedProductOptions` に正しい値がセットされること

---

### 2.14. オプション選択後の注文処理 (`confirmOptionSelection adds product with options`)
- **目的**:  
  オプションを選択した状態で注文を確定すると、商品の金額がオプションの価格分加算され、カートおよびセッションに正しい情報が保存されることを確認します。

- **検証内容**:
  - オプション付き商品を対象に、オプションを選択して `confirmOptionSelection()` を実行  
  - カート内に追加された商品の価格が、基本価格とオプション価格の合計になっていること  
  - カート情報がセッションに正しく反映されていること

---

### 2.15. オプション選択キャンセル (`cancelOptionSelection resets selection`)
- **目的**:  
  オプション選択をキャンセルした際に、選択状態がすべてリセットされ、ポップアップが非表示になることを確認します。

- **検証内容**:
  - 事前に選択情報（`selectedProductId`, `selectedProductOptions`, `selectedOptionIds`）と、表示状態 (`showOptionsPopup`) を設定  
  - `cancelOptionSelection()` を実行後、各選択情報がリセットされ、ポップアップが閉じられていることを確認

---

## 3. テスト実施方法と注意点

- **データベースのリフレッシュ**  
  - `RefreshDatabase` トレイトを利用して、各テスト前にデータベースの状態をリセットしています。

- **セッション管理**  
  - `session()` ヘルパーを用いてカート情報の永続化をテストしており、フロントエンドと同様の状態を再現します。

- **データベース検証**  
  - `assertDatabaseHas` や `assertDatabaseMissing` を利用して、注文情報や在庫更新が正しく行われたかを確認します。

- **Livewire コンポーネントのテスト**  
  - メソッド呼び出しにより、OrderPage の各機能（カート操作、支払い処理、オプション選択など）を実際に動作させ、その結果を検証します。

---

このテスト計画によって、`OrderPage` コンポーネント内のカート操作、支払い計算、注文処理、さらに商品オプションの選択と反映がすべて正しく機能することを保証し、ユーザーが直面する可能性のある各シナリオに対して堅牢な動作が確認されます。
