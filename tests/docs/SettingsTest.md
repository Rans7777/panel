# SettingsTest テスト概要

このテストファイルでは、`Settings` ページに関連する動作や設定の更新処理が、認証ユーザーの権限に応じて正しく動作するかを検証しています。特に、管理者ユーザーと非管理者ユーザーのアクセス制御、フォームへの設定値の読み込み、及び環境設定ファイル（.env）の更新処理が対象です。

---

## 1. ダミーユーザーの定義

- **DummyAdmin**
  - 管理者ユーザーを模擬するためのモデルです。
  - テーブルは `admin` を使用し、`hasRole` メソッドでは `'admin'` ロールの場合に `true` を返します。

- **DummyNonAdmin**
  - 非管理者ユーザーを模擬するモデルです。
  - テーブルは `user` を使用し、常に `hasRole` メソッドで `false` を返すため、管理者権限を持ちません。

---

## 2. テストケースの詳細

### 2.1 管理者ユーザーによる Settings ページのマウント
- **テストケース:** `admin user can mount settings page successfully`
- **目的:**  
  管理者ユーザーが `Settings` ページを問題なくマウントでき、システムの各設定（APP_NAME、APP_DEBUG、APP_TIMEZONE、APP_LOCALE、APP_URL など）がフォームへ正しく反映されることを確認します。
- **実装の流れ:**  
  1. `DummyAdmin` インスタンスで認証状態を設定します。
  2. テスト用に複数のアプリケーション設定値を `config` に設定。
  3. ダミーのフォームオブジェクト（`fill` と `getState` メソッドを持つ匿名クラス）を作成し、`Settings` ページに注入。
  4. `mount()` を実行後、フォームの状態が設定値と一致していることを検証します。

---

### 2.2 非管理者ユーザーによる Settings ページのマウント
- **テストケース:** `non-admin user is redirected when mounting settings page`
- **目的:**  
  管理者権限を持たないユーザーが `Settings` ページにアクセスしようとした場合、アクセスがブロックされ、指定されたリダイレクト先 (`/admin/`) に遷移することを確認します。
- **実装の流れ:**  
  1. `DummyNonAdmin` インスタンスで認証状態を設定します。
  2. 同様にダミーのフォームオブジェクトを `Settings` ページに注入。
  3. `mount()` 実行時に `HttpResponseException` が発生することを期待し、例外から返されるレスポンスが `RedirectResponse` であるか、及びリダイレクト先が `/admin/` であることを検証します。

---

### 2.3 ナビゲーション登録の検証
- **テストケース:** `shouldRegisterNavigation returns proper value`
- **目的:**  
  ユーザーの権限に応じて、`Settings` ページが管理画面のナビゲーションに登録されるかどうかを確認します。
- **実装の流れ:**  
  1. 管理者ユーザーとして認証した場合、`Settings::shouldRegisterNavigation()` が `true` を返すこと。
  2. 非管理者ユーザーの場合、同メソッドが `false` を返すことを検証します。

---

### 2.4 updateEnv 処理 - .env ファイルが存在しない場合
- **テストケース:** `updateEnv does nothing if .env file does not exist`
- **目的:**  
  環境設定の更新処理 `updateEnv()` が `.env` ファイルの存在を確認し、存在しない場合には何もしない（例外が発生しない）ことを確認します。
- **実装の流れ:**  
  1. 管理者ユーザーとして認証を設定。
  2. ダミーのフォームオブジェクトで一部の設定値（例: `APP_NAME`）を準備。
  3. `File::exists` をモックし、`.env` ファイルが存在しない状態（`false` を返す）をシミュレート。
  4. `updateEnv()` を実行し、エラーなく処理が終了することを確認します。

---

### 2.5 updateEnv 処理 - .env ファイル更新成功
- **テストケース:** `updateEnv updates .env file successfully`
- **目的:**  
  管理者ユーザーがフォームから更新した設定値を基に、`.env` ファイルの内容を正しく更新できることを確認します。
- **実装の流れ:**  
  1. 管理者ユーザーとして認証し、ダミーのフォームオブジェクトに新しい設定値（例: `APP_NAME`, `APP_DEBUG`, `APP_TIMEZONE` など）をセット。
  2. 元の `.env` ファイルの内容（例: "APP_NAME=OldApp\nOTHER_KEY=value"）をモックで返すよう設定。
  3. `File::exists` と `File::get` を適切にモックし、`.env` ファイルが存在する前提の状態を再現。
  4. `File::put` で新しい内容が保存される際、更新後の `APP_NAME=TestApp` が含まれているかを検証。
  5. `Artisan::call('config:clear')` が呼び出され、キャッシュがクリアされる処理も確認します。

---

## 3. テスト実施のポイント

- **認証と権限:**  
  ダミーの認証ユーザー（管理者・非管理者）を明示的に設定することで、各権限に応じた動作（アクセス制御、ナビゲーション登録）が正しく行われるかを検証しています。

- **モックの使用:**  
  ファイル操作（`.env` ファイルの有無、内容の取得、書き込み）や Artisan コマンドの呼び出しはモックによってシミュレーションし、実際のファイルシステムに影響を及ぼさずにテストが実施されます。

- **例外処理の検証:**  
  非管理者ユーザーがアクセスした際の `HttpResponseException` のハンドリング方法をテストすることで、アクセス制御の堅牢性を確保しています。

---

このテスト計画により、`Settings` ページにおける設定の読み込み、環境ファイルの更新およびアクセス制御が、ユーザーの権限に応じて正確に機能していることが保証されます。
